<!DOCTYPE html>
<html>
<head>
    <title>DeltaStories</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var e=this.getContext().getProject().ObjectID,t="",a="";this.releases=[];var o="",l="";console.log("project: ",e);var r=Ext.create("Ext.form.field.Date",{fieldLabel:"From:",listeners:{select:function(e,a){t=a.toISOString()}}}),n=Ext.create("Ext.form.field.Date",{fieldLabel:"To:",listeners:{select:function(e,t){a=t.toISOString()}}}),i=Ext.create("Ext.panel.Panel",{type:"vbox",align:"stretch",padding:5,itemId:"datePanel",componentCls:"panel"}),s=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"releaseComboBox",scope:this,listeners:{ready:function(e){l=e.getRecord().get("ObjectID"),o=e.getRecord().get("Name")},select:function(e,t,a){l=e.getRecord().get("ObjectID"),o=e.getRecord().get("Name")}}}),d=Ext.create("Rally.ui.Button",{text:"Search",scope:this,handler:function(){this._doSearch(t,a,e,o,l)}}),c=Ext.create("Ext.panel.Panel",{layout:"hbox",padding:5,itemId:"parentPanel",items:[{xtype:"panel",title:"Features At Start Date",flex:1,itemId:"childPanel1"},{xtype:"splitter"},{xtype:"panel",title:"Features At End Date",flex:1,itemId:"childPanel2"}]});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:c}),this.add(i),i.add(r),i.add(n),i.add(s),i.add(d),this.add(c)},_doSearch:function(e,t,a,o,l){console.log("parent release name: ",o),console.log("looking for:",e,t,a),""!=e&&""!=t&&(this.myMask.show(),Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"Project.parent.ObjectID",value:a},{property:"name",value:o}],listeners:{load:function(o,r,n){if(r.length>0){console.log("multiple releases found:",r);var i=[];_.each(r,function(e){i.push(e.get("ObjectID"))}),this.releases=i,console.log("releases: ",this.releases)}else console.log("single release found, using baseReleaseId:",l),this.releases.push(l);this.filtersInit=[{property:"__At",value:e},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",operator:"in",value:this.releases}],this.filtersEnd=[{property:"__At",value:t},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",operator:"in",value:this.releases}],this._loadInitData()},scope:this},fetch:["Description","Name","ObjectID"]}))},_loadInitData:function(){console.log("loading init stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","State","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo"],filters:this.filtersInit,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["State"],listeners:{load:function(e,t,a){this.initItems=t,this._loadEndData()},scope:this}})},_loadEndData:function(){console.log("loading end stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","State","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo"],filters:this.filtersEnd,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["State"],listeners:{load:function(e,t,a){this.endItems=t,this._onStoriesLoaded(),this.myMask.hide()},scope:this}})},_onStoriesLoaded:function(){var e,t=[],a=[],o=[],l=[];_.each(this.initItems,function(e){o.push(e.get("ObjectID"))}),console.log("initIds",o),_.each(this.endItems,function(e){l.push(e.get("ObjectID"))}),console.log("endIds",l),_.each(this.endItems,function(t){e=t.get("ObjectID");var l=!0;Ext.Array.contains(o,e)||(l=!1),a.push({_ref:"/portfolioitem/feature/"+e,Name:t.get("Name"),FormattedID:t.get("FormattedID"),State:t.get("State"),PercentDoneByStoryPlanEstimate:t.get("PercentDoneByStoryPlanEstimate"),Planned:l,LeafStoryPlanEstimateTotal:t.get("LeafStoryPlanEstimateTotal")})},this),_.each(this.initItems,function(a){e=a.get("ObjectID");var o=!1;Ext.Array.contains(l,e)||(o=!0),t.push({_ref:"/portfolioitem/feature/"+e,Name:a.get("Name"),FormattedID:a.get("FormattedID"),State:a.get("State"),PercentDoneByStoryPlanEstimate:a.get("PercentDoneByStoryPlanEstimate"),Removed:o,LeafStoryPlanEstimateTotal:a.get("LeafStoryPlanEstimateTotal")})},this);var r=Ext.create("Rally.data.custom.Store",{data:t,pageSize:1e3}),n=Ext.create("Rally.data.custom.Store",{data:a,pageSize:1e3});this._createInitGrid(r,"#childPanel1"),this._createEndGrid(n,"#childPanel2")},_createInitGrid:function(e,t){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:t+"Grid",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Sum of Story Plan Estimate",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"Feature State",dataIndex:"State",tdCls:"x-change-cell"},{xtype:"templatecolumn",text:"Percent Done By Story Plan Estimate",dataIndex:"PercentDoneByStoryPlanEstimate",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate")}],viewConfig:{getRowClass:function(e,t,a,o){if(1==e.get("Removed"))return"attention"}}});this.add(a);var o=this.down(t);o.removeAll(!0),o.add(a)},_createEndGrid:function(e,t){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:t+"Grid",id:t+"Grid",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Sum of Story Plan Estimate",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"Feature State",dataIndex:"State",tdCls:"x-change-cell"},{xtype:"templatecolumn",text:"Percent Done By Story Plan Estimate",dataIndex:"PercentDoneByStoryPlanEstimate",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate")}],viewConfig:{getRowClass:function(e,t,a,o){if(0==e.get("Planned"))return"new-feature"}}}),o=this.down(t);o.removeAll(!0),o.add(a)}});

            Rally.launchApp('CustomApp', {
                name:"DeltaStories",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .attention .x-change-cell{background-color:#ffe2e2 !important;color:#900}.new-feature .x-change-cell{background-color:#c2d7f9 !important;color:#009}
    </style>
</head>
<body>
</body>
</html>
