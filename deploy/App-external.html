<!DOCTYPE html>
<html>
<head>
    <title>DeltaStories</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var t=this.getContext().getProject().ObjectID;this.projectId=t;var e="",a="";this.releases=[];var o="",l="";console.log("project: ",t);var r=Ext.create("Ext.form.field.Date",{fieldLabel:"From:",scope:this,listeners:{select:function(t,a){e=a.toISOString()}}}),n=Ext.create("Ext.form.field.Date",{fieldLabel:"To:",listeners:{select:function(t,e){a=e.toISOString()}}}),i=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"releaseComboBox",scope:this,listeners:{ready:function(t){l=t.getRecord().get("ObjectID"),o=t.getRecord().get("Name")},select:function(t,e,a){l=t.getRecord().get("ObjectID"),o=t.getRecord().get("Name")}}}),d=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,a,t,o,l)}}),s=Ext.create("Ext.panel.Panel",{title:"Feature Summary",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"featureSummaryPanel"}),c=Ext.create("Ext.panel.Panel",{title:"Story Summary",layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"storySummaryPanel"}),m=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"datePanel",items:[{xtype:"panel",flex:1,itemId:"filterPanel"},{xtype:"panel",flex:1,itemId:"tooltipPanel"}]}),u=Ext.create("Ext.panel.Panel",{layout:"hbox",padding:5,itemId:"parentPanel",items:[{xtype:"panel",title:"Features At Start Date",flex:1,itemId:"childPanel1"},{xtype:"splitter"},{xtype:"panel",title:"Features At End Date",flex:1,itemId:"childPanel2"}]});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this.add(m),m.down("#filterPanel").add(r),m.down("#filterPanel").add(n),m.down("#filterPanel").add(i),m.down("#filterPanel").add(d),m.down("#tooltipPanel").add({id:"tooltipContent1",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#cdf9c2; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Features present at start date and at the end date with state <b>Staging</b> or <b>Done</b>.</div></div>'},{id:"tooltipContent2",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#c2d7f9; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Features absent at the start date and present at end date.</div></div>'},{id:"tooltipContent3",padding:5,height:45,overflowX:"auto",overflowY:"auto",html:'<div style= "clear:both"><div style="background-color:#ffe2e2; width:20px; height:20px; margin:5px; float:left;"></div><div style="height:20px; margin:5px; float:left;">Features present at the start date, but absent at end date.</div></div>'}),this.add(s),this.add(c),this.add(u)},_doSearch:function(t,e,a,o,l){console.log("parent release name: ",o),console.log("looking for:",t,e,a),this.initDate=t,this.endDate=e,""!=t&&""!=e&&(this.myMask.show(),this.releases=[],Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.ObjectID",value:a},{property:"name",value:o}]),Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.parent.ObjectID",value:a},{property:"name",value:o}]),Rally.data.QueryFilter.and([{property:"Project.parent.parent.ObjectID",value:a},{property:"name",value:o}])])]),listeners:{load:function(o,r,n){if(r.length>0){console.log("multiple releases found:",r);var i=[];_.each(r,function(t){i.push(t.get("ObjectID"))}),this.releases=i,console.log("releases: ",this.releases)}else console.log("single release found, using baseReleaseId:",l),this.releases=[l];this.filtersInit=[{property:"__At",value:t},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",operator:"in",value:this.releases}],this.filtersEnd=[{property:"__At",value:e},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",operator:"in",value:this.releases}],this._loadInitData()},scope:this},fetch:["Description","Name","ObjectID"],limit:1/0}))},_loadInitData:function(){console.log("loading init features");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","State","Parent","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo"],filters:this.filtersInit,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State"],listeners:{load:function(t,e,a){console.log("Init Store",t),this.initItems=e,this._loadEndData()},scope:this}})},_loadEndData:function(){console.log("loading end features");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","PreliminaryEstimate","State","Parent","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo","LeafStoryCount","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","ActualEndDate"],filters:this.filtersEnd,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State"],listeners:{load:function(t,e,a){this.endItems=e,this._onStoriesLoaded()},scope:this}})},_onStoriesLoaded:function(){var t,e=[],a=[],o=[],l=[],r=[];_.each(this.initItems,function(t){var e;o.push(t.get("ObjectID")),""!=t.get("Parent")&&(e=t.get("Parent")),e&&!Ext.Array.contains(r,e)&&r.push(e)}),console.log("initIds",o),_.each(this.endItems,function(t){var e;l.push(t.get("ObjectID")),""!=t.get("Parent")&&(e=t.get("Parent")),e&&!Ext.Array.contains(r,e)&&r.push(e)}),console.log("endIds",l);var n=this._loadInitStories(o),i=this._loadEndStories(l),d=this._loadParentNames(r);Deft.Promise.all([d,n,i]).then({success:function(r){console.log("promises:",r);var n=r[0];_.each(this.endItems,function(t){var e=t.get("ObjectID"),l=t.get("State"),r=!0,i=!1;Ext.Array.contains(o,e)||(r=!1),"Done"!=l&&"Staging"!=l||(i=!0),a.push({_ref:"/portfolioitem/feature/"+e,Name:t.get("Name"),FormattedID:t.get("FormattedID"),State:t.get("State"),PercentDoneByStoryPlanEstimate:t.get("PercentDoneByStoryPlanEstimate"),Planned:r,Parent:n.get(t.get("Parent")),Completed:i,LeafStoryPlanEstimateTotal:t.get("LeafStoryPlanEstimateTotal"),LeafStoryCount:t.get("LeafStoryCount"),PreliminaryEstimate:t.get("PreliminaryEstimate"),AcceptedLeafStoryCount:t.get("AcceptedLeafStoryCount"),AcceptedLeafStoryPlanEstimateTotal:t.get("AcceptedLeafStoryPlanEstimateTotal"),ActualEndDate:t.get("ActualEndDate")})},this),_.each(this.initItems,function(a){t=a.get("ObjectID");var o=!1;Ext.Array.contains(l,t)||(o=!0),e.push({_ref:"/portfolioitem/feature/"+t,Name:a.get("Name"),FormattedID:a.get("FormattedID"),State:a.get("State"),PercentDoneByStoryPlanEstimate:a.get("PercentDoneByStoryPlanEstimate"),Removed:o,Parent:n.get(a.get("Parent")),LeafStoryPlanEstimateTotal:a.get("LeafStoryPlanEstimateTotal"),LeafStoryCount:a.get("LeafStoryCount"),PreliminaryEstimate:a.get("PreliminaryEstimate")})},this);var i=Ext.create("Rally.data.custom.Store",{data:e,pageSize:1e4}),d=Ext.create("Rally.data.custom.Store",{data:a,pageSize:1e4}),s=r[1],c=r[2];this._createSummaryGrid(e,a,s,c),this._createInitGrid(i,"#childPanel1"),this._createEndGrid(d,"#childPanel2"),this.myMask.hide()},failure:function(t){console.log("error:",t)},scope:this})},_loadInitStories:function(t){var e=Ext.create("Deft.Deferred");console.log("loading init stories",this.initDate,this.projectId);var a=[{property:"__At",value:this.initDate},{property:"_ProjectHierarchy",value:this.projectId},{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"PortfolioItem",operator:"in",value:t}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","ObjectID","ScheduleState","PlanEstimate","_ValidFrom","_ValidTo"],hydrate:["ScheduleState"],filters:a,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("stories data loaded:",a);var l=[];_.each(a,function(t){l.push(t.get("ObjectID"))}),e.resolve(a)},scope:this}});return e.promise},_loadEndStories:function(t){var e=Ext.create("Deft.Deferred");console.log("loading end stories",this.endDate,this.projectId);var a=[{property:"__At",value:this.endDate},{property:"_ProjectHierarchy",value:this.projectId},{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"PortfolioItem",operator:"in",value:t}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","ObjectID","ScheduleState","PlanEstimate","_ValidFrom","_ValidTo"],hydrate:["ScheduleState"],filters:a,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("end stories data loaded:",a);var l=[];_.each(a,function(t){l.push(t.get("ObjectID"))}),e.resolve(a)},scope:this}});return e.promise},_loadParentNames:function(t){var e=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Initiative",autoLoad:!0,fetch:["Name","ObjectID","FormattedID"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:t}],limit:1/0,listeners:{load:function(t,o,l){_.each(o,function(t){var a=t.get("FormattedID")+" - "+t.get("Name");e.add(t.get("ObjectID"),a)}),a.resolve(e)}},scope:this}),a.promise},_loadPreliminaryEstimates:function(){var t=new Ext.util.MixedCollection,e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PreliminaryEstimate",autoLoad:!0,fetch:["Name","ObjectID","Value"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},limit:1/0,listeners:{load:function(a,o,l){_.each(o,function(e){var a=e.get("Value");t.add(e.get("ObjectID"),a)}),e.resolve(t)}},scope:this}),e.promise},_createInitGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",store:t,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Parent",dataIndex:"Parent",flex:1,tdCls:"x-change-cell"},{text:"Leaf Story Plan Estimate Total",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"Feature State",dataIndex:"State",tdCls:"x-change-cell"},{xtype:"templatecolumn",text:"Percent Done By Story Plan Estimate",dataIndex:"PercentDoneByStoryPlanEstimate",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{isClickable:!1,showDangerNotificationFn:function(){return!1}})}],viewConfig:{getRowClass:function(t,e,a,o){if(1==t.get("Removed"))return"attention"}}}),o=this.down(e);o.removeAll(!0),o.add(a)},_createEndGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",id:e+"Grid",store:t,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Parent",dataIndex:"Parent",flex:1,tdCls:"x-change-cell"},{text:"Leaf Story Plan Estimate Total",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"Feature State",dataIndex:"State",tdCls:"x-change-cell"},{xtype:"templatecolumn",text:"Percent Done By Story Plan Estimate",dataIndex:"PercentDoneByStoryPlanEstimate",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{isClickable:!1,showDangerNotificationFn:function(){return!1}})},{text:"Actual End Date",dataIndex:"ActualEndDate",xtype:"datecolumn",format:"m/d/Y",tdCls:"x-change-cell"}],viewConfig:{getRowClass:function(t,e,a,o){return 0==t.get("Planned")?"new-feature":1==t.get("Completed")?"completed":void 0}}}),o=this.down(e);o.removeAll(!0),o.add(a)},_createSummaryGrid:function(t,e,a,o){var l=0,r=0,n=0,i=0,d=0,s=0,c=0,m=0,u=0,y=0,p=0,f=0,x=0,h=0,E=0,g=0,S=0,P=0,C=0,I=0,v=0,D=0,b=0,T=0,R=0,j=0,A=this._loadPreliminaryEstimates();Deft.Promise.all([A]).then({success:function(A){console.log("preliminary estimates loaded",A[0]);var w=A[0];E=this._calculateTotalStoryCountRemoved(a,o),g=this._calculateTotalStoryEstimateRemoved(a,o),_.each(t,function(t){l+=1,x+=t.LeafStoryCount,h+=t.LeafStoryPlanEstimateTotal,""!=t.PreliminaryEstimate&&(r+=w.get(t.PreliminaryEstimate)),t.Removed&&(n+=1,""!=t.PreliminaryEstimate&&(i+=w.get(t.PreliminaryEstimate)))}),C=this._calculateTotalStoryCountAdded(a,o),I=this._calculateTotalStoryEstimateAdded(a,o),_.each(e,function(t){d+=1,S+=t.LeafStoryCount,P+=t.LeafStoryPlanEstimateTotal,R+=t.AcceptedLeafStoryCount,j+=t.AcceptedLeafStoryPlanEstimateTotal,""!=t.PreliminaryEstimate&&(s+=w.get(t.PreliminaryEstimate)),t.Planned||(c+=1,""!=t.PreliminaryEstimate&&(m+=w.get(t.PreliminaryEstimate))),"Staging"!=t.State&&"Done"!=t.State||(u+=1,v+=t.LeafStoryCount,D+=t.LeafStoryPlanEstimateTotal,""!=t.PreliminaryEstimate&&(y+=w.get(t.PreliminaryEstimate))),"Staging"!=t.State&&"Done"!=t.State&&(p+=1,""!=t.PreliminaryEstimate&&(f+=w.get(t.PreliminaryEstimate)))}),b=S-R,T=P-j;var F=[];F.push({totalFeatureCount:l,totalPreliminaryEstimate:r,totalCountRemoved:n,totalPreliminaryEstimateRemoved:i,totalFeatureCountEnd:d,totalPreliminaryEstimateEnd:s,totalCountAdded:c,totalPreliminaryEstimateAdded:m,totalCountCompleted:u,totalPreliminaryEstimateCompleted:y,totalCountNotCompleted:p,totalPreliminaryEstimateNotCompleted:f,totalStoryCount:x,totalStoryEstimate:h,totalStoryCountRemoved:E,totalStoryEstimateRemoved:g,totalStoryCountEnd:S,totalStoryEstimateEnd:P,totalStoryCountAdded:C,totalStoryEstimateAdded:I,totalStoryCountCompleted:v,totalStoryEstimateCompleted:D,totalStoryCountNotCompleted:b,totalStoryEstimateNotCompleted:T});var L=Ext.create("Ext.data.JsonStore",{fields:["totalFeatureCount","totalPreliminaryEstimate","totalCountRemoved","totalPreliminaryEstimateRemoved","totalFeatureCountEnd","totalPreliminaryEstimateEnd","totalCountAdded","totalPreliminaryEstimateAdded","totalCountCompleted","totalPreliminaryEstimateCompleted","totalCountNotCompleted","totalPreliminaryEstimateNotCompleted","totalStoryCount","totalStoryEstimate","totalStoryCountRemoved","totalStoryEstimateRemoved","totalStoryCountEnd","totalStoryEstimateEnd","totalStoryCountAdded","totalStoryEstimateAdded","totalStoryCountCompleted","totalStoryEstimateCompleted","totalStoryCountNotCompleted","totalStoryEstimateNotCompleted"]});L.loadData(F),this._createFeatureSummaryGrid(L),this._createStorySummaryGrid(L)},failure:function(t){console.log("error:",t)},scope:this})},_calculateTotalStoryCountRemoved:function(t,e){var a=[],o=[],l=0;return _.each(t,function(t){a.push(t.get("ObjectID"))}),_.each(e,function(t){o.push(t.get("ObjectID"))}),_.each(t,function(t){Ext.Array.contains(o,t.get("ObjectID"))||(l+=1)}),l},_calculateTotalStoryEstimateRemoved:function(t,e){var a=[],o=[],l=0,r=0,n=0;return _.each(t,function(t){a.push(t.get("ObjectID")),r+=t.get("PlanEstimate")}),_.each(e,function(t){o.push(t.get("ObjectID")),n+=t.get("PlanEstimate")}),_.each(t,function(t){Ext.Array.contains(o,t.get("ObjectID"))||(l+=t.get("PlanEstimate"))}),console.log("total story estimate",r),console.log("total story estimate end ",n),l},_calculateTotalStoryCountAdded:function(t,e){var a=[],o=[],l=0;return _.each(t,function(t){a.push(t.get("ObjectID"))}),_.each(e,function(t){o.push(t.get("ObjectID"))}),_.each(e,function(t){Ext.Array.contains(a,t.get("ObjectID"))||(l+=1)}),l},_calculateTotalStoryEstimateAdded:function(t,e){var a=[],o=[],l=0;return _.each(t,function(t){a.push(t.get("ObjectID"))}),_.each(e,function(t){o.push(t.get("ObjectID"))}),_.each(e,function(t){Ext.Array.contains(a,t.get("ObjectID"))||(l+=t.get("PlanEstimate"))}),l},_createFeatureSummaryGrid:function(t){var e=Ext.create("Ext.grid.Panel",{store:t,height:85,forceFit:!0,viewConfig:{enableTextSelection:!0},columns:[{text:"Start Items",flex:1,columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalFeatureCount"},{text:"Total Preliminary Estimate",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimate"},{text:"Total Count Removed",flex:1,sortable:!1,dataIndex:"totalCountRemoved"},{text:"Total Preliminary Estimate Removed",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimateRemoved"}]},{text:"End Items",columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalFeatureCountEnd"},{text:"Total Preliminary Estimate",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimateEnd"},{text:"Total Count Added",flex:1,sortable:!1,dataIndex:"totalCountAdded"},{text:"Total Preliminary Estimate Added",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimateAdded"},{text:"Total Count Completed",flex:1,sortable:!1,dataIndex:"totalCountCompleted"},{text:"Total Preliminary Estimate Completed",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimateCompleted"},{text:"Total Count Not Completed",flex:1,sortable:!1,dataIndex:"totalCountNotCompleted"},{text:"Total Preliminary Estimate Not Completed",flex:1,sortable:!1,dataIndex:"totalPreliminaryEstimateNotCompleted"}]}]});this.down("#featureSummaryPanel").removeAll(!0),this.down("#featureSummaryPanel").add(e)},_createStorySummaryGrid:function(t){var e=Ext.create("Ext.grid.Panel",{store:t,height:85,forceFit:!0,viewConfig:{enableTextSelection:!0},columns:[{text:"Start Items",flex:1,columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalStoryCount"},{text:"Total Estimate",flex:1,sortable:!1,dataIndex:"totalStoryEstimate"},{text:"Total Count Removed",flex:1,sortable:!1,dataIndex:"totalStoryCountRemoved"},{text:"Total Estimate Removed",flex:1,sortable:!1,dataIndex:"totalStoryEstimateRemoved"}]},{text:"End Items",columns:[{text:"Total Count",flex:1,sortable:!1,dataIndex:"totalStoryCountEnd"},{text:"Total Estimate",flex:1,sortable:!1,dataIndex:"totalStoryEstimateEnd"},{text:"Total Count Added",flex:1,sortable:!1,dataIndex:"totalStoryCountAdded"},{text:"Total Estimate Added",flex:1,sortable:!1,dataIndex:"totalStoryEstimateAdded"},{text:"Total Count Completed",flex:1,sortable:!1,dataIndex:"totalStoryCountCompleted"},{text:"Total Estimate Completed",flex:1,sortable:!1,dataIndex:"totalStoryEstimateCompleted"},{text:"Total Story Count Not Completed",flex:1,sortable:!1,dataIndex:"totalStoryCountNotCompleted"},{text:"Total Story Estimate Not Completed",flex:1,sortable:!1,dataIndex:"totalStoryEstimateNotCompleted"}]}]});this.down("#storySummaryPanel").removeAll(!0),this.down("#storySummaryPanel").add(e)}});

            Rally.launchApp('CustomApp', {
                name:"DeltaStories",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .attention .x-change-cell{background-color:#ffe2e2 !important;color:#900}.new-feature .x-change-cell{background-color:#c2d7f9 !important;color:#009}.completed .x-change-cell{background-color:#cdf9c2 !important;color:#090}
    </style>
</head>
<body>
</body>
</html>
