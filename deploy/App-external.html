<!DOCTYPE html>
<html>
<head>
    <title>DeltaStories</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var t=this.getContext().getProject().ObjectID,e="",a="",o="";console.log(t);var l=Ext.create("Ext.form.field.Date",{fieldLabel:"From:",listeners:{select:function(t,a){console.log(a),e=a.toISOString()}}}),i=Ext.create("Ext.form.field.Date",{fieldLabel:"To:",listeners:{select:function(t,e){console.log(e),a=e.toISOString()}}}),n=Ext.create("Ext.panel.Panel",{type:"vbox",align:"stretch",padding:5,itemId:"datePanel",componentCls:"panel"}),s=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"releaseComboBox",scope:this,listeners:{ready:function(t){o=t.getRecord().get("ObjectID")},select:function(t,e,a){o=t.getRecord().get("ObjectID")}}}),r=Ext.create("Rally.ui.Button",{text:"Search",scope:this,handler:function(){console.log(e,a),this._doSearch(e,a,t,o)}}),d=Ext.create("Ext.panel.Panel",{layout:"hbox",padding:5,itemId:"parentPanel",cls:"attention-row",items:[{xtype:"panel",title:"Stories At Start Date",flex:1,itemId:"childPanel1"},{xtype:"splitter"},{xtype:"panel",title:"Stories At End Date",flex:1,itemId:"childPanel2"}]});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:d}),this.add(n),n.add(l),n.add(i),n.add(s),n.add(r),this.add(d)},_doSearch:function(t,e,a,o){console.log("looking for",t,e,a),""!=t&&""!=e&&(this.filtersInit=[{property:"__At",value:t},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",value:o}],this.filtersEnd=[{property:"__At",value:e},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:a},{property:"Release",value:o}],this.myMask.show(),this._loadInitData())},_loadInitData:function(){console.log("loading init stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","State","_ValidFrom","_ValidTo","PlanEstimate","ScheduleState"],filters:this.filtersInit,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["ScheduleState","State"],listeners:{load:function(t,e,a){this.initItems=e,this._loadEndData()},scope:this}})},_loadEndData:function(){console.log("loading end stories");Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","State","_ValidFrom","_ValidTo","PlanEstimate","ScheduleState"],filters:this.filtersEnd,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],hydrate:["ScheduleState","State"],listeners:{load:function(t,e,a){this.endItems=e,this._onStoriesLoaded(),this.myMask.hide()},scope:this}})},_onStoriesLoaded:function(t,e){var a,o=[],l=[],i=[],n=[];_.each(this.initItems,function(t){i.push(t.get("ObjectID"))}),console.log("initIds",i),_.each(this.endItems,function(t){n.push(t.get("ObjectID"))}),console.log("endIds",n),_.each(this.endItems,function(t){a=t.get("ObjectID");var e=!0;console.log("checking if",a,"exists in",i),Ext.Array.contains(i,a)||(e=!1),l.push({Name:t.get("Name"),FormattedID:t.get("FormattedID"),PlanEstimate:t.get("PlanEstimate"),ScheduleState:t.get("ScheduleState"),State:t.get("State"),Planned:e,LeafStoryPlanEstimateTotal:t.get("LeafStoryPlanEstimateTotal")})},this),_.each(this.initItems,function(t){a=t.get("ObjectID");var e=!1;console.log("checking if",a,"exists in",n),Ext.Array.contains(n,a)||(e=!0),o.push({Name:t.get("Name"),FormattedID:t.get("FormattedID"),PlanEstimate:t.get("PlanEstimate"),ScheduleState:t.get("ScheduleState"),State:t.get("State"),Removed:e,LeafStoryPlanEstimateTotal:t.get("LeafStoryPlanEstimateTotal")})},this);var s=Ext.create("Rally.data.custom.Store",{data:o,pageSize:1e3}),r=Ext.create("Rally.data.custom.Store",{data:l,pageSize:1e3});this._createInitGrid(s,"#childPanel1"),this._createEndGrid(r,"#childPanel2")},_createInitGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",id:e+"Grid",store:t,columnCfgs:[{text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell"},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Plan Estimate",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"State",dataIndex:"State",tdCls:"x-change-cell"}],viewConfig:{getRowClass:function(t,e,a,o){if(1==t.get("Removed"))return console.log("changing css for records",t,"index",e),"attention"}}}),o=this.down(e);o.removeAll(!0),o.add(a)},_createEndGrid:function(t,e){var a=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:e+"Grid",id:e+"Grid",store:t,columnCfgs:[{text:"ID",dataIndex:"FormattedID",tdCls:"x-change-cell"},{text:"Name",dataIndex:"Name",flex:1,tdCls:"x-change-cell"},{text:"Plan Estimate",dataIndex:"LeafStoryPlanEstimateTotal",tdCls:"x-change-cell"},{text:"State",dataIndex:"State",tdCls:"x-change-cell"}],viewConfig:{getRowClass:function(t,e,a,o){if(0==t.get("Planned"))return console.log("changing css for records",t,"index",e),"new-feature"}}}),o=this.down(e);o.removeAll(!0),o.add(a)}});

            Rally.launchApp('CustomApp', {
                name:"DeltaStories",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .attention .x-change-cell{background-color:#ffe2e2 !important;color:#900}.new-feature .x-change-cell{background-color:#c2d7f9 !important;color:#009}
    </style>
</head>
<body>
</body>
</html>
